<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

<h:head>
    <title>INKALOTO - Bingo</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="css/style.css" rel="stylesheet" type="text/css"/>
</h:head>

<h:body>

<header class="topbar">
    <div class="container nav-slim">
        <a href="index.xhtml" class="brand">INKALOTO</a>

        <div class="nav-slim-right">

            <!-- Si NO est√° logueado -->
            <h:panelGroup rendered="#{loginBean.usuarioLogueado == null}">
                <a href="login.xhtml" class="btn btn-dark">Iniciar sesi√≥n</a>
                <a href="registro.xhtml" class="btn btn-gold pill">Reg√≠strate</a>
            </h:panelGroup>

            <!-- Si S√ç est√° logueado -->
            <h:panelGroup rendered="#{loginBean.usuarioLogueado != null}">
            <!-- üîî ahora puedes usar el total de no le√≠das en ESTA p√°gina -->
            <a href="#{request.contextPath}/notificaciones.xhtml"
                class="notif-icon"
                title="Notificaciones">
                 üîî
                 <span id="notifCount" class="notif-badge">
                     #{notificacionesBean.cantidadNoLeidas}
                 </span>
             </a>


                <a href="cargarsaldo.xhtml" class="btn btn-dark pill">+ Cargar saldo</a>

                <span class="balance-mini">
                    S/
                    <strong>
                        <h:outputText id="saldoHeader" value="#{miCuentaBean.billetera.saldoActual}">
                            <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                        </h:outputText>
                    </strong>
                </span>

                <div class="select user-select">
                    <select id="userMenu"
                            onchange="if(this.value){ window.location = this.value; }">
                        <option selected="selected">
                            #{loginBean.usuarioLogueado.nombres}
                        </option>
                    <option value="#{request.contextPath}/micuenta.xhtml">Mi cuenta</option>
                    <option value="#{request.contextPath}/historialtransacciones.xhtml">Movimientos</option>
                    <option value="#{request.contextPath}/historialjugada.xhtml">Historial de jugadas</option>
                    <option value="#{request.contextPath}/historialpremios.xhtml">Premios</option>
                    <option value="#{request.contextPath}/notificaciones.xhtml">Notificaciones</option>
                    <option value="#{request.contextPath}/retiro.xhtml">Retirar premios</option>
                    </select>
                </div>
                                    <!-- Cerrar sesi√≥n -->
                                    <h:form style="display:inline;">
                    <h:commandButton value="Cerrar sesi√≥n"
                                     action="#{loginBean.logout}"
                                     styleClass="btn-logout" />
                </h:form>

            </h:panelGroup>

        </div>
    </div>
</header>

<main class="panel">
    <div class="panel-inner">
        <h1>Bingo <span class="accent">en l√≠nea</span></h1>
        <p class="hint">
            Compra tu cart√≥n y juega. El costo se descuenta de tu saldo de INKALOTO.
        </p>

        <!-- FORMULARIO JSF -->
        <h:form styleClass="form" id="formCompra">

            <div class="grid g-2">
                <div class="field">
                    <label for="precio">Precio por cart√≥n</label>
                    <div class="select">
                        <h:selectOneMenu id="precio"
                                         value="#{bingoBean.precio}">
                            <f:selectItem itemValue="1.00" itemLabel="S/ 1.00" />
                            <f:selectItem itemValue="2.00" itemLabel="S/ 2.00" />
                            <f:selectItem itemValue="5.00" itemLabel="S/ 5.00" />
                        </h:selectOneMenu>
                    </div>
                </div>

                <div class="field">
                    <label for="cantidad">Cantidad</label>
                    <h:inputText id="cantidad"
                                 value="#{bingoBean.cantidad}"
                                 type="number"
                                 min="1" />
                </div>
            </div>

            <p class="hint">
                Total: S/
                <strong>
                    <h:outputText value="#{bingoBean.total}">
                        <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                    </h:outputText>
                </strong>
            </p>

            <!-- Cartones disponibles -->
            <p class="hint">
                Cartones disponibles:
                <strong id="lblCartones">0</strong>
            </p>

            <!-- Hidden para JS -->
            <h:inputHidden id="cartonesDisponibles"
                           value="#{bingoBean.cartonesDisponibles}" />

            <!-- Mensajes -->
            <div class="field">
                <h:panelGroup id="panelMsg">
                    <h:panelGroup rendered="#{not empty bingoBean.mensajeError}">
                        <p class="withdraw-status" style="color:red;">
                            #{bingoBean.mensajeError}
                        </p>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{not empty bingoBean.mensajeExito}">
                        <p class="withdraw-status" style="color:green;">
                            #{bingoBean.mensajeExito}
                        </p>
                    </h:panelGroup>
                </h:panelGroup>
            </div>

            <div class="actions-row">
                <h:commandButton value="Comprar y generar cart√≥n"
                                 styleClass="btn btn-gold"
                                 action="#{bingoBean.comprarCarton}">
                    <f:ajax execute="@form"
                            render="@form :saldoHeader"
                            onevent="onCompraBingoAjax"/>
                </h:commandButton>
            </div>

        </h:form>

        <!-- ===== CART√ìN Y CONTROLES DEL BINGO (visual / JS) ===== -->
        <section class="bingo-wrap" style="margin-top:24px;">

            <!-- Cart√≥n -->
            <div class="bingo-card" id="card" aria-label="Cart√≥n de bingo">
                <div class="bingo-head">B</div>
                <div class="bingo-head">I</div>
                <div class="bingo-head">N</div>
                <div class="bingo-head">G</div>
                <div class="bingo-head">O</div>
                <!-- Las 25 celdas se llenan por JS -->
            </div>

            <!-- Panel derecho -->
            <div class="bingo-controls">
                <div class="now-number">
                    √öltimo n√∫mero: <strong id="ultimoNum">‚Äî</strong>
                </div>

                <div class="actions-row">
                    <button class="btn btn-dark" id="btnSacar" type="button">Sacar n√∫mero</button>
                    <button class="btn btn-dark" id="btnNuevo" type="button">Reiniciar</button>
                </div>

                <div class="bingo-list">
                    <p class="hint">N√∫meros salidos</p>
                    <div id="listaNumeros" class="nums"></div>
                </div>

                <div class="bingo-status" id="estadoJuego" role="status" aria-live="polite"></div>
            </div>

        </section>

    </div>
</main>

<footer class="footer">
    ¬© 2025 INKALOTO ‚Äî Bingo en l√≠nea.
</footer>

<!-- üîπ NUEVO: form oculto para guardar la jugada en BD -->
<h:form id="formJugada">
    <h:inputHidden id="numeros" value="#{bingoBean.numerosSacadosJS}" />
    <h:inputHidden id="resultado" value="#{bingoBean.resultadoJS}" />
    <h:commandButton id="btnGuardarJugada"
                     action="#{bingoBean.registrarJugada}"
                     style="display:none" />
</h:form>

<!-- Tu JS externo -->
<script src="jsp/bingo.js" type="text/javascript"></script>

</h:body>
</html>
